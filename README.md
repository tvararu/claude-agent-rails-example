# Claude Agent Rails Example

This is an exploration into 3 different approaches to integrating Claude Code /
Claude Agent with a Rails application:

1) Via
[claude-agent-sdk-ruby](https://github.com/ya-luotao/claude-agent-sdk-ruby), an
unofficial Ruby port of the Claude Agent Python SDK which spawns Node
subprocesses

2) Via
[claude-agent-sdk-typescript](https://github.com/anthropics/claude-agent-sdk-typescript),
the official TypeScript SDK, and a persistent sidecar Node process

3) Via [claude-code-acp](https://github.com/zed-industries/claude-code-acp), an
unofficial [Agent Client Protocol](https://agentclientprotocol.com) wrapper and
separate subprocesses

![Demo video](docs/demo.mov)

The spikes are documented in `./docs/`.

## TL;DR

The spikes were generated by Claude Code. All of them work, but they are not
idiomatic or perfect Ruby code by any means. The purpose of this repo was more
to explore and see the limitations of each approach.

My personal gut feeling is that #1 or #2 work best, and which one is preferable
depends on your setup, whether you use a monolith or are open to microservices.

`claude-agent-sdk-ruby` in itself is a very new library and in early
development. If I would use it myself, I'd probably fork it or make sure I read
it in its entirety so that I'm prepared to assume control and change any bits
that don't work well.

I recommend reviewing the PRs, but skimming through, not getting too hung up on
the details:

- [Complete Spike 1: Claude Agent SDK Ruby](https://github.com/tvararu/claude-agent-rails-spike/pull/1)
- [Complete Spike 2: Claude Agent SDK TypeScript](https://github.com/tvararu/claude-agent-rails-spike/pull/2)
- [Complete Spike 3: Claude ACP](https://github.com/tvararu/claude-agent-rails-spike/pull/3)

#2 can probably be implemented using an off-the-shelf Docker image, there are a
few out there. I didn't test any for this, YMMV. That could be nicer though.

This was implemented sequentially; Claude built each spike in turn, and as such
the different implementations probably draw from each other a bit. I had to
/compact after each one, and had to /compact mid-way through the ACP one which
was trickiest.

**[ğŸ“‹ Read LLM's comprehensive analysis and conclusions â†’](docs/llm-conclusions.md)**

## Architecture comparison

| Aspect | Ruby SDK | TypeScript SDK | ACP |
|--------|----------|----------------|-----|
| **Communication** | Gem manages subprocess | HTTP POST/SSE | Subprocess + stream JSON |
| **Services** | Single (Rails) | Multi (Rails + Node) | Single (Rails) |
| **Tool Pattern** | In-process MCP | HTTP callbacks | MCP via stdio |
| **Language** | Ruby + Node (gem-managed) | Ruby + TypeScript | Ruby + Node (CLI) |
| **Standardization** | Unofficial gem | Official SDK | MCP protocol |

## Motivation

Claude Code is a very powerful framework for automation, not just for writing
code. There are many usecases where giving an LLM tool-use, filesystem access,
and permission to run and execute scripts vastly enhances its capabilities.

While the objective of this repo is to display a GUI that lets you chat to a
Claude Code-style interface directly, that's not the only way. You can spawn an
agent entirely in the background, using jobs/workers, and give it tools to read
and write to the database.

This spike is about finding the cleanest, most maintainable way to do so.

## Setup

This repo was generated with:

```sh
rails new claude-agent-rails-spike \
          -c tailwind \
          --skip-action-mailer \
          --skip-action-mailbox \
          --skip-action-text \
          --skip-jbuilder \
          --skip-kamal \
          --skip-docker \
          --skip-ci \
          --skip-test
```

To run:

```sh
cp mise.local.toml.example mise.local.toml
mise install
bin/setup
```

## Results

### Spike 1 (Claude Agent SDK Ruby)

**Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚â”€â”€â”€â”€â”€â–¶â”‚ Rails Server â”‚â”€â”€â”€â”€â”€â–¶â”‚ claude-agent-sdk-   â”‚â”€â”€â”€â”€â”€â–¶â”‚ Claude API â”‚
â”‚         â”‚â—€â”€â”€â”€â”€â”€â”‚ (ActionCable)â”‚â—€â”€â”€â”€â”€â”€â”‚ ruby Gem            â”‚â—€â”€â”€â”€â”€â”€â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ (manages Node       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚             â”‚  subprocess)        â”‚
                         â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼                        â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
                  â”‚ ActiveRecord â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚  (MCP tools) â”‚   In-process calls
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**
- Single Rails service, gem manages Node subprocess internally
- MCP tools execute in-process with direct ActiveRecord access
- Simplest integration, minimal configuration

**[ğŸ“„ Read full spike results â†’](docs/spike-ruby-sdk-results.md)**

![Claude Agent SDK Ruby](docs/spike-ruby-sdk-screenshot.png)

### Spike 2 (Claude Agent SDK TypeScript)

**Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚â”€â”€â”€â”€â”€â–¶â”‚ Rails Server â”‚â”€â”€â”€â”€â”€â–¶â”‚ Node Service    â”‚â”€â”€â”€â”€â”€â–¶â”‚ Claude API â”‚
â”‚         â”‚â—€â”€â”€â”€â”€â”€â”‚ (ActionCable)â”‚â—€â”€â”€â”€â”€â”€â”‚ (TypeScript SDK)â”‚â—€â”€â”€â”€â”€â”€â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–²                        â”‚
                         â”‚                        â”‚ Tool execution
                         â”‚                        â”‚ (HTTP callbacks)
                         â”‚                        â–¼
                         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Rails API       â”‚
                            HTTP POST   â”‚  /api/schema    â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ ActiveRecord â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**
- Two separate services: Rails + Node (runs via Procfile)
- Tools execute via HTTP callbacks to Rails API
- Independent scaling, microservices architecture

**[ğŸ“„ Read full spike results â†’](docs/spike-typescript-sdk-results.md)**

![Claude Agent SDK Ruby](docs/spike-typescript-sdk-screenshot.png)

### Spike 3 (Claude ACP)

**Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚â”€â”€â”€â”€â”€â–¶â”‚ Rails Server â”‚â”€â”€â”€â”€â”€â–¶â”‚ Claude CLI      â”‚â”€â”€â”€â”€â”€â–¶â”‚ Claude API â”‚
â”‚         â”‚â—€â”€â”€â”€â”€â”€â”‚ (ActionCable)â”‚â—€â”€â”€â”€â”€â”€â”‚  (subprocess)   â”‚â—€â”€â”€â”€â”€â”€â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ --output-format â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚             â”‚  stream-json    â”‚
                         â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                        â”‚
                         â”‚                        â”‚ MCP protocol
                         â”‚                        â”‚ (JSON-RPC stdio)
                         â”‚                        â–¼
                         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚              â”‚ Ruby MCP Server â”‚
                         â”‚              â”‚  mcp_server.rb  â”‚
                         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                        â”‚
                         â”‚                        â–¼
                         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ActiveRecord    â”‚
                            Direct      â”‚  (check_schema) â”‚
                            access      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**
- Single Rails service, spawns Claude CLI subprocess per connection
- Ruby MCP server communicates via stdio (JSON-RPC)
- Pure Ruby tool development with direct ActiveRecord access
- Clean separation via MCP protocol

**[ğŸ“„ Read full spike results â†’](docs/spike-acp-results.md)**

![Claude ACP](docs/spike-acp-screenshot.png)

## License

[MIT](LICENSE).
